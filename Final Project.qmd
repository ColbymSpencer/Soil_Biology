---
title: "Final Project"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---
Alt + O to close all open chunks (makes it more readable)
#### SETUP
```{r libraries}
library(tidyverse)
library(readxl)

```

```{r import data}
group_raw <- read_excel("data for each group_2025.xlsx", 
                        sheet = 'group',
                        col_types = 'text') 

data_raw <- read_excel("data for each group_2025.xlsx",
                       sheet = 'Raw Data Reformatted',
                       skip = 1) 
  
```

Make group data tidy - one observation per row, one variable per column, and one value per cell. Tidy data is easier to visualize and work with in R. 

Rename and convert data types of the raw data for analysis.
```{r clean_data}
#### GROUPS ####
group <- 
  group_raw |>
  ## clean multiple values per cell
  separate_longer_delim(cols = Cropland_2025,
                        delim = ' ') |>
  separate_longer_delim(cols = Grassland_2025,
                        delim = ' ') |>
  separate_longer_delim(cols = Forest_2025,
                        delim = ' ') |>
  separate_longer_delim(cols = Grassland_2024,
                        delim = ' ') |>
  separate_longer_delim(cols = Forest_2024,
                        delim = ' ') |>
  pivot_longer(cols = (contains('_')),
               names_to = 'landuse_year',
               values_to = 'plot') |>
  separate(landuse_year, c('landuse', 'year'), '_') |>
  filter(!is.na(plot), plot != 'plot', plot != '') |>
  distinct() |>
  janitor::clean_names() |>
  mutate(year = as_factor(year),
         group = as_factor(group),
         plot = as.factor(plot),
         landuse = tolower(landuse))

#### DATA ####
data <- 
  data_raw |>
  mutate(
    # convert dtypes
    year = as_factor(year),
    plot = as_factor(plot)
  ) |>
  janitor::clean_names() |>
  rename(
    'c_pct' = total_c_percent,
    'n_pct' = total_n_percent,
    'ph' = p_h_k_cl,
    'gmc' = grametric_moisture_content,
    'mass_soilDry' = bulk_density_g_soil_core_with_a_diameter_and_a_depth_of_5_cm,
    'earthworm_count' = earthworm_number_individuals_0_12_m2,
    'earthworm_mass' = earthworm_fresh_weight_g_0_12m2,
    'pct_loss' = material_loss_after_34_days_percent,
    'decomp_constant' = decompostion_constant_k_d_1,
    'microarthropods' = total_microarthropods_individuals_per_soil_core,
    'mites' = mites_individuals_per_soil_core,
    'springrails' = springtails_individuals_per_soil_core,
    'others' = other_microarthropods_individuals_per_soil_core,
    'pnp_wet' = p_nitrophenol_produced_mg_g_fresh_soil_per_hour,
    'nematodes' = nematodes_individuals_from_50_g_fresh_soil,
    'c_fumigated' = fumigated_c_mg_l,
    'c_nonfumigated' = non_fumigated_c_mg_l
  )

```

filter the data for only our groups data
```{r filter_raw}
group6 <- 
  group #|>
  # filter(group_number == 6)

data6 <- left_join(group6, data) |>
  select(-group, -group_number)

rm(data_raw, data, group, group_raw, group6)
```

#### SOIL PROPERTIES

convert carbon and nitrogen to mg/kg
carbon and nitrogen are in % with values ranging from 0 to 100.




convert GMC to percent (already in percent?)

convert bulk density to g/cm3

```{r soil_properties}
soil_properties <-
  data6 |>
  select(
    landuse, year, plot,
    c_pct:mass_soilDry
  ) |>
  mutate(
    bulk_density = mass_soilDry / (3.14 * (5 / 2)^2), # g/cm^3
    n = n_pct * 10000, #mg/kg
    c = c_pct * 10000 #mg/kg
  )
```

-   ***c_pct:*** \[GIVEN\] Percentage of soil mass that is carbon (grams carbon/grams soil). Value between 0 and 100

-   ***n_pct:*** \[GIVEN\] Percentage of soil mass that is nitrogen (grams nitrogen/grams soil). Value between 0 and 100

-   ***c:*** mass ratio between nitrogen and the total soil sample (mg/kg)

-   ***n:*** mass ratio between carbon and the total soil sample (mg/kg)

-   ***ph:*** \[GIVEN\] pH-KCl

-   ***gmc:*** \[GIVEN\] gravimetric moisture content the mass of water in the soil divided by the mass of the dry material, typically expressed as a percentage or decimal (e.g., g water/g dry soil). It's measured by weighing a wet sample, oven-drying it until all water evaporates, and then re-weighing the dry sample; the difference reveals the water mass.

-   ***mass_soilDry:*** \[GIVEN\] the dry mass of a 5cm deep and 5cm diameter soil core

-   ***mass_soilWet:*** the wet mass of a 5cm deep and 5cm diameter soil core

-   ***bulk_density*** the density of the dry soil core

#### WORMS

convert to individuals per m2

Earthworms were sampled from two 0.06m^2 soil samples and totaled per plot to find the count. 
```{r worms}

worms <- 
  data6 |>
  select(landuse, year, plot, 
         'count' = earthworm_count,
         'mass' = earthworm_mass) |>
  mutate(
    density = count / 0.12, # individuals/m2
    mass_density = mass / 0.12 #g/m^2
         ) |>
  select(plot, landuse, year, density, mass_density)
```

-   ***density*** number of earthworms observed per square meter

-   ***mass_density*** the average density of earthworm mass per square meter

#### ARTHROPODS

convert to individuals per square meter

```{r}

arthropods <- 
  data6 |>
  select(landuse, year, plot, microarthropods:others) |>
  pivot_longer(cols = microarthropods:others,
               values_to = 'count',
               names_to = 'organism') |>
  mutate(
    density = count / (5/2)^2
  )
```

-   ***organism*** microarthropod being viewed: all microarthropods, mites, springtails, or others

-   ***density*** number of organisms per square meter. We assume there are no microbes under the soil sample. 

#### NEMATODES

Task: convert data to ind./100 g dry soil

gmc = (wet-dry) / dry dry = wet / (gmc +1)

```{r nematodes}
nematodes <- 
  data6 |>
  select(landuse, year, plot, nematodes) |>
  left_join(soil_properties |>
              select(landuse, year, plot, gmc)) |>
  mutate(
    dry = 50 / (gmc + 1),
    nematode_density_dry = nematodes / dry,
    nematode_estimate_100 = nematode_density_dry * 100
  ) 
```

-   ***nematodes:*** \[GIVEN\] estimated number of nematodes in 50g of fresh soil

-   ***gmc:*** \[GIVEN\] gravimetric_moisture_content

-   ***dry:*** amount of dry soil in the 50g fresh soil sample

-   ***nematode_density_dry:*** number of nematodes expected to be found in 1g of dry soil.

-   ***nematode_estimate_100:*** number of nematodes estimated to be found in 100g of soil

#### DECOMPOSITION

convert data to percent (already in percent?)

```{r}
decomp <- data6 |>
  select(landuse, year, plot, pct_loss, decomp_constant)
```

#### ENZYMES

convert data to µg PNP/g dry soil per hour

gmc = (wet-dry) / dry 

dry = wet / (gmc +1)

pnp_wet = micrograms pnp / 1g wet soil

pnp_dry = micrograms pnp / 1g dry soil

we assume there is no interaction between soil moisture and pnp production

```{r}
enzymes <- 
  data6 |>
  select(landuse, year, plot, pnp_wet) |>
  left_join(soil_properties |>
              select(landuse, year, plot, gmc)) |>
  mutate(
    dry = 1 / (gmc + 1), 
    pnp_dry = pnp_wet / dry
    )
  
```

-   ***pnp_wet:*** \[GIVEN\] amount of pnp produced in micrograms per gram of fresh soil

-   ***dry:*** amount of dry soil in one gram of fresh soil

-   ***pnp_dry:*** amount of pnp produced in micrograms per gram of dry soil

#### MCIROBIAL BIOMASS CARBON

calculate mbc according to the protocol

special note: fumigated should be higher than non-fumigated. If it is not, swap the values.

```{r}
mbc <- 
  data6 |>
  select(landuse, year, plot, c_fumigated, c_nonfumigated)|>
  left_join(soil_properties |> 
              select(landuse, year, plot, gmc)) |>
  mutate(
    soil_wet_weight = 30, #g, given in protocol
    extractant_volume = 60, #mL, given in protocol
    ws = gmc, #g water / g dry soil
    ms = soil_wet_weight / (1+ws),
    vs = (soil_wet_weight - ms) + extractant_volume,
    cf = c_fumigated * vs / ms,
    cnf = c_nonfumigated * vs / ms,
    mbc = (cf-cnf) / .045 # 0.45 is k_ec value
  )
```

#### EXPLORATORY DATA ANALYSIS

No notable relationships
```{r ph_decomposition}
# underpants decomposition does not appear related with PH
left_join(decomp, soil_properties) |>
  ggplot() +
  geom_point(aes(x = ph, y = pct_loss, color = landuse)) +
  labs(y = 'Percent Decomposition',
       x = 'pH-KCl',
       title = 'Underpant Decomposition and pH')

# underpants decomposition does not appear linearly related to PNP production
left_join(decomp, enzymes) |>
  ggplot() +
  geom_point(aes(x = pnp_dry, y = pct_loss, color = landuse)) +
  labs(y = 'Percent Decomposition',
       x = 'PNP Production (ug/g)',
       title = 'Underpant Decomposition and PNP')



```

ph and enzymes
```{r ph_enzymes}
left_join(soil_properties, enzymes) |>
  ggplot() +
  geom_point(aes(x = ph, y = pnp_dry, color = landuse)) +
  labs(y = 'PNP Production (ug/g)',
       x = 'pH-KCl',
       title = 'PNP Production and pH')
```


```{r ph_landuse}
soil_properties |>
  ggplot() +
  geom_boxplot(aes(y = ph, fill = landuse))+
  facet_wrap(~landuse, scales  = 'free_y') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs( title = 'Differences in pH Across Landuses',
        y = 'pH-KCl',
        x = 'Landuse')

```

ph-population is messed up but i will fix
```{r ph_population}
nematodes |>
  select(landuse, year, plot, 'density' = nematode_density_dry) |>
  mutate(organism = 'nematode') |>
  rbind(arthropods |> 
          select(-count)) |>
  left_join(soil_properties) |>

  ggplot() +
  geom_point(aes(x = ph, y = density, color = landuse)) +
  
  facet_wrap(~organism, scales = 'free')
```

```{r landuse_populations}
nematodes |>
  select(landuse, year, plot, 'density' = nematode_density_dry) |>
  mutate(organism = 'nematode') |>
  rbind(arthropods |> 
          select(-count)) |>
  left_join(soil_properties) |>

  ggplot() +
  geom_boxplot(aes(x = organism, y = density)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~landuse)

```

```{r bulkDensity_landuse}
soil_properties |>
  ggplot() +
  geom_boxplot(aes(x = landuse, y = bulk_density, fill = landuse))
```

```{r enzymeActivity_soilCarbon}
left_join(soil_properties, enzymes) |>
    # glimpse()
  ggplot() +
  geom_point(aes(x = c, y = pnp_dry, color = landuse)) +
  labs(title = 'PNP Production and Soil Carbon',
       y = 'PNP / Dry Soil (µg/g)', 
       x = 'Carbon (mg/kg)')

```

```{r bulkDensity_microbialActivity}
left_join(mbc, soil_properties) |>
  ggplot() +
  geom_point(aes(x = bulk_density, y = mbc, color = landuse)) 
```

no clear relationship
```{r gmc_wormDensity}
# worms per square meter and soil moisture
left_join(soil_properties, worms) |>
  ggplot() +
  geom_point(aes(x = gmc, y = density, color = landuse))

# worm mass per square meter and soil moisture 
left_join(soil_properties, worms) |>
  ggplot() +
  geom_point(aes(x = gmc, y = mass_density, color = landuse))
```

```{r coorelationMatrix}
correlation_matrix <- arthropods |>
  select(-count) |>
  pivot_wider( 
               names_from = organism,
               values_from = density) |>
  select(microarthropods:others) |> 
  cor() 

library(ggcorrplot)
ggcorrplot(correlation_matrix, 
           method ="square",
           type = 'lower',
           lab = TRUE)
```

ORGANISMS AND SOIL PROPERTIES
```{r nematode}
nematodes |>
  left_join(soil_properties, join_by(landuse, year, plot, gmc)) |>
  select('density' = nematode_density_dry, c, n, ph, gmc, bulk_density) |>
  pivot_longer(c:bulk_density,
               names_to = 'attribute',
               values_to = 'value')  |>
  ggplot() +
  geom_point(aes(y = density, x = value)) +
  # geom_smooth(aes(y = density, x = value)) +
  facet_wrap(~attribute, scales = 'free')
```
```{r worms_soilProperties}
worms |>
  left_join(soil_properties) |>
  select(density, c, n, ph, gmc, bulk_density) |>
  pivot_longer(c:bulk_density,
               names_to = 'attribute',
               values_to = 'value')  |>
  ggplot() +
  geom_point(aes(y = density, x = value)) +
  geom_smooth(aes(y = density, x = value)) +
  facet_wrap(~attribute, scales = 'free')
```
```{r mar_soilProperties}
arthropods |>
  left_join(soil_properties) |>
  select(organism, density, c, n, ph, gmc, bulk_density) |>
  pivot_longer(c:bulk_density,
               names_to = 'attribute',
               values_to = 'value')  |>
  ggplot() +
  geom_point(aes(y = density, x = value)) +
  geom_smooth(aes(y = density, x = value, color = organism)) +
  facet_wrap(organism~attribute, scales = 'free')
```


DECOPMOSITION RATE AND SOIL PROPERTIES
```{r}
left_join(decomp, soil_properties) |>
  pivot_longer(cols = c(ph, gmc, bulk_density, c, n),
               names_to = 'attribute',
               values_to = 'value') |>
  filter(landuse == 'forest') |>
  ggplot() +
  geom_point(aes(x = value, y = pct_loss, color = attribute)) +
  # geom_smooth(aes(x = value, y = pct_loss, color = attribute)) +
  facet_wrap(~attribute, scales = 'free')
```

#### STATISTICAL SIGNIFICANCE
```{r libraries}
source('custom_functions.R')
```


Based on β-glucosidase activity measurements across different
land use types, which ecosystem demonstrates the most efficient
carbon cycling and why is this enzyme activity a reliable indicator
for this assessment?
```{r}

```


How does microbial biomass in forest soils compare to
agricultural or grassland soils, and what is the relationship with
soil bulk density?
```{r}
dataset1 <- left_join(mbc, soil_properties) |>
  select(landuse, bulk_density, mbc)

ggplot(dataset1) +
  geom_point(aes(x = bulk_density, y = mbc, color = landuse))

# stats
# one way anova for bulk density and for mbc
anova_bd <- aov(bulk_density ~ landuse, data = dataset1)
summary(anova_bd)
TukeyHSD(anova_bd)

# mbc is signifcantly different between all landuses
anova_mbc <- aov(mbc ~ landuse, data = dataset1)
summary(anova_mbc)
TukeyHSD(anova_mbc)


```

